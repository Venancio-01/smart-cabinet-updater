<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <title>载体数据统计</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../lib/layui/css/layui.css" media="all">
    <script src="../lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
    <script src="../js/framework-clientdata.js?v=@WaterCloud.Code.GlobalContext.GetVersion()"></script>
    <script src="../js/framework-ui.js?v=@WaterCloud.Code.GlobalContext.GetVersion()"></script>
    <script src="../lib/layui/layui.js?v=@WaterCloud.Code.GlobalContext.GetVersion()"></script>
    <script src="../js/lay-config.js?v=@WaterCloud.Code.GlobalContext.GetVersion()" charset="utf-8"></script>
    <script src="../js/lay-module/loading/wcLoading.js?v=@WaterCloud.Code.GlobalContext.GetVersion()" charset="utf-8"></script>

    <link rel="stylesheet" href="../css/smartscreen2.css">
    <script>
        window.onload = function () {
            $(".page-loading").fadeOut();
        }

        $(document).ready(function () {
            const setResponsiveFontSize = () => {
                const windowWidth = $(window).width();
                $("html").css({ fontSize: windowWidth / 20 });
            };

            setResponsiveFontSize();
            $(window).resize(setResponsiveFontSize);
        });
    </script>
</head>

<body>
    <!-- 页面加载动画 -->
    <div class="page-loading">
        <div class="loading-container">
            <img src="../picture/loading.gif" alt="加载中">
            <span class="loading-text">页面加载中...</span>
        </div>
    </div>

    <!-- 页面头部 -->
    <header class="page-header">
        <h1 class="header-title">数据统计</h1>
        <div class="header-weather">
            <span id="currentDateTime" class="datetime-display"></span>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main class="dashboard-container">
        <!-- 左侧图表区域 -->
        <div class="chart-column">
            <section class="data-panel carrier-type-panel">
                <h2 class="panel-title">载体类型</h2>
                <div class="panel-content" id="carrierTypeChart"></div>
                <div class="panel-footer"></div>
            </section>

            <section class="data-panel document-type-panel">
                <h2 class="panel-title">公文种类</h2>
                <div class="panel-content" id="documentTypeChart"></div>
                <div class="panel-footer"></div>
            </section>
        </div>

        <!-- 中间统计数据区域 -->
        <div class="stats-column">
            <div class="stats-container">
                <!-- 载体和文件数量统计 -->
                <div class="stats-group">
                    <div class="stats-row">
                        <ul class="stats-list clearfix">
                            <li class="stats-item">
                                <span class="stats-number counter" id="totalCarriers">0</span>
                            </li>
                            <li class="stats-item">
                                <span class="stats-number counter" id="totalDocuments">0</span>
                            </li>
                        </ul>
                    </div>
                    <div class="stats-labels">
                        <ul class="stats-list clearfix">
                            <li class="stats-label">载体数量</li>
                            <li class="stats-label">文件数量</li>
                        </ul>
                    </div>
                </div>

                <!-- 登记次数统计 -->
                <!-- <div class="stats-group">
                        <div class="stats-row">
                            <ul class="stats-list clearfix">
                                <li class="stats-item">
                                    <span class="stats-number counter" id="totalRegistrations">0</span>
                                </li>
                            </ul>
                        </div>
                        <div class="stats-labels">
                            <ul class="stats-list clearfix">
                                <li class="stats-label">载体外出登记次数</li>
                            </ul>
                        </div>
                    </div> -->
                <!-- 外出和报警次数统计 -->
                <div class="stats-group">
                    <div class="stats-row">
                        <ul class="stats-list clearfix">
                            <li class="stats-item">
                                <span class="stats-number counter" id="totalOutings">0</span>
                            </li>
                            <li class="stats-item">
                                <span class="stats-number counter" id="totalAlarms">0</span>
                            </li>
                        </ul>
                    </div>
                    <div class="stats-labels">
                        <ul class="stats-list clearfix">
                            <li class="stats-label">载体外出次数</li>
                            <li class="stats-label">载体报警次数</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="alarm-record-container">
                <table class="alarm-record-table">
                    <thead>
                        <tr>
                            <th>载体名称</th>
                            <th>设备名称</th>
                            <th>报警时间</th>
                            <th>是否处理</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 右侧图表区域 -->
        <div class="chart-column">
            <section class="data-panel outing-stats-panel">
                <h2 class="panel-title">外出统计</h2>
                <div class="panel-content" id="outingStatsChart"></div>
                <div class="panel-footer"></div>
            </section>

            <section class="data-panel alarm-stats-panel">
                <h2 class="panel-title">报警统计</h2>
                <div class="panel-content" id="alarmStatsChart"></div>
                <div class="panel-footer"></div>
            </section>
        </div>
    </main>

    <!-- 背景 -->
    <div class="page-background"></div>

    <!-- 脚本引用 -->
    <script src="../lib/layui/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js" charset="utf-8"></script>
    <script src="../js/framework-ui.js"></script>
    <script src="../js/lay-module/waterCloud/common.js"></script>

    <!-- 业务逻辑脚本 -->
    <script>
        let documentChart;
        let alarmChart;
        let outingChart;
        let carrierChart;

        // 图表配置常量
        const CHART_CONFIG = {
            xAxisData: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            fontSize: '16',
            colors: ['#F35331', '#2499F8', '#3DF098', '#33B734'],
            fontFamily: 'HarmonyOS_Sans_SC_Medium'
        };

        // 时间显示相关
        let timeUpdateTimer = null;

        function updateDateTime() {
            clearTimeout(timeUpdateTimer);
            const now = new Date();
            const dateTimeString = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日-${now.getHours()}时${now.getMinutes()}分${now.getSeconds()}秒`;
            document.getElementById("currentDateTime").innerHTML = dateTimeString;
            timeUpdateTimer = setTimeout(updateDateTime, 1000);
        }

        // 载体类型图表
        function initCarrierTypeChart() {
            layui.use(['echarts'], function () {
                const echarts = layui.echarts;
                $.ajax({
                    type: "GET",
                    url: "../api/SmartScreen/CarType",
                    dataType: "json",
                    success: function (response) {
                        const { TypeName: carrierTypes, TypeCount: carrierCounts } = response;

                        if (!carrierChart) {
                            carrierChart = echarts.init(document.getElementById('carrierTypeChart'));
                        }

                        const option = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' }
                            },
                            grid: {
                                left: '20',
                                top: '10',
                                right: '20',
                                bottom: '10',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'value',
                                splitLine: { show: false },
                                boundaryGap: false,
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: "rgba(255,255,255,.1)",
                                        width: 1,
                                        type: "solid"
                                    },
                                },
                                axisLabel: {
                                    show: true,
                                    splitNumber: 15,
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                            },
                            yAxis: {
                                inverse: true,
                                type: 'category',
                                data: carrierTypes,
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: "rgba(255,255,255,.1)",
                                        width: 1,
                                        type: "solid"
                                    },
                                },
                                axisLabel: {
                                    show: true,
                                    splitNumber: 15,
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                            },
                            series: [{
                                name: '数量',
                                type: 'bar',
                                data: carrierCounts,
                                barWidth: '35%',
                                itemStyle: {
                                    normal: {
                                        color: '#27d08a',
                                        opacity: 1,
                                        barBorderRadius: 5,
                                    }
                                }
                            }]
                        };

                        carrierChart.setOption(option);
                    }
                });

                window.addEventListener("resize", () => carrierChart?.resize());
            });
        }

        // 文档类型图表
        function initDocumentTypeChart() {
            layui.use(['echarts'], function () {
                const echarts = layui.echarts;
                $.ajax({
                    type: "GET",
                    url: "../api/SmartScreen/DocType",
                    dataType: "json",
                    success: function (response) {
                        const { TypeName: docTypes, TypeCount: docCounts } = response;

                        if (!documentChart) {
                            documentChart = echarts.init(document.getElementById('documentTypeChart'));
                        }

                        const option = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: { type: 'shadow' }
                            },
                            grid: {
                                left: '20',
                                top: '10',
                                right: '20',
                                bottom: '10',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'value',
                                boundaryGap: false,
                                splitLine: { show: false },
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: "rgba(255,255,255,.1)",
                                        width: 1,
                                        type: "solid"
                                    },
                                },
                                axisLabel: {
                                    show: true,
                                    splitNumber: 15,
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                            },
                            yAxis: {
                                inverse: true,
                                type: 'category',
                                data: docTypes,
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: "rgba(255,255,255,.1)",
                                        width: 1,
                                        type: "solid"
                                    },
                                },
                                axisLabel: {
                                    show: true,
                                    splitNumber: 15,
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                            },
                            series: [{
                                name: '数量',
                                type: 'bar',
                                data: docCounts,
                                barWidth: '35%',
                                itemStyle: {
                                    normal: {
                                        color: '#2f89cf',
                                        opacity: 1,
                                        barBorderRadius: 5,
                                    }
                                }
                            }]
                        };

                        documentChart.setOption(option);
                    }
                });

                window.addEventListener("resize", () => documentChart?.resize());
            });
        }

        // 获取统计数据
        function fetchStatisticsData() {
            $.ajax({
                type: "GET",
                url: "../api/SmartScreen/DataCount",
                dataType: "json",
                success: function (response) {
                    $('#totalCarriers').html(response.CarCount);
                    $('#totalDocuments').html(response.DocCount);
                    $('#totalRegistrations').html(response.RegCount);
                    $('#totalOutings').html(response.CarOutCount);
                    $('#totalAlarms').html(response.CarOutErrCount);
                }
            });
        }

        // 外出统计图表
        function initOutingStatsChart() {
            layui.use(['echarts'], function () {
                const echarts = layui.echarts;
                $.ajax({
                    type: "GET",
                    url: "../api/SmartScreen/GetOutCount",
                    dataType: "json",
                    success: function (response) {
                        const outingCounts = response.TypeCount;

                        if (!outingChart) {
                            outingChart = echarts.init(document.getElementById('outingStatsChart'));
                        }

                        const option = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: {
                                    lineStyle: { color: '#dddc6b' }
                                }
                            },
                            legend: {
                                top: '0%',
                                data: ['外出次数'],
                                textStyle: {
                                    color: 'rgba(255,255,255,.5)',
                                    fontSize: CHART_CONFIG.fontSize,
                                    fontFamily: CHART_CONFIG.fontFamily
                                }
                            },
                            grid: {
                                left: '20',
                                top: '30',
                                right: '20',
                                bottom: '10',
                                containLabel: true
                            },
                            xAxis: [{
                                type: 'category',
                                boundaryGap: false,
                                data: CHART_CONFIG.xAxisData,
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: "rgba(255,255,255,.1)",
                                        width: 1,
                                        type: "solid"
                                    },
                                },
                                axisLabel: {
                                    show: true,
                                    interval: 0,
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                            }],
                            yAxis: [{
                                type: 'value',
                                axisTick: { show: false },
                                axisLine: {
                                    lineStyle: { color: 'rgba(255,255,255,.1)' }
                                },
                                axisLabel: {
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                                splitLine: {
                                    lineStyle: { color: 'rgba(255,255,255,.1)' }
                                }
                            }],
                            series: [{
                                name: '外出次数',
                                type: 'line',
                                smooth: true,
                                symbol: 'circle',
                                symbolSize: 5,
                                showSymbol: false,
                                lineStyle: {
                                    normal: {
                                        color: '#0184d5',
                                        width: 2
                                    }
                                },
                                areaStyle: {
                                    normal: {
                                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                            offset: 0,
                                            color: 'rgba(1, 132, 213, 0.4)'
                                        }, {
                                            offset: 0.8,
                                            color: 'rgba(1, 132, 213, 0.1)'
                                        }], false),
                                        shadowColor: 'rgba(0, 0, 0, 0.1)',
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        color: '#0184d5',
                                        borderColor: 'rgba(221, 220, 107, .1)',
                                        borderWidth: 12
                                    }
                                },
                                data: outingCounts
                            }]
                        };
                        outingChart.setOption(option);
                    }
                });

                window.addEventListener("resize", () => outingChart?.resize());
            });
        }

        // 报警统计图表
        function initAlarmStatsChart() {
            layui.use(['echarts'], function () {
                const echarts = layui.echarts;
                $.ajax({
                    type: "GET",
                    url: "../api/SmartScreen/GetOutErrCount",
                    dataType: "json",
                    success: function (response) {
                        const alarmCounts = response.TypeCount;

                        if (!alarmChart) {
                            alarmChart = echarts.init(document.getElementById('alarmStatsChart'));
                        }

                        const option = {
                            tooltip: {
                                trigger: 'axis',
                                axisPointer: {
                                    lineStyle: { color: '#dddc6b' }
                                }
                            },
                            legend: {
                                top: '0%',
                                data: ['报警次数'],
                                textStyle: {
                                    color: 'rgba(255,255,255,.5)',
                                    fontSize: CHART_CONFIG.fontSize,
                                    fontFamily: CHART_CONFIG.fontFamily
                                }
                            },
                            grid: {
                                left: '20',
                                top: '30',
                                right: '20',
                                bottom: '10',
                                containLabel: true
                            },
                            xAxis: [{
                                type: 'category',
                                boundaryGap: false,
                                data: CHART_CONFIG.xAxisData,
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: "rgba(255,255,255,.1)",
                                        width: 1,
                                        type: "solid"
                                    },
                                },
                                axisLabel: {
                                    show: true,
                                    interval: 0,
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                            }],
                            yAxis: [{
                                type: 'value',
                                axisTick: { show: false },
                                axisLine: {
                                    lineStyle: { color: 'rgba(255,255,255,.1)' }
                                },
                                axisLabel: {
                                    textStyle: {
                                        color: "rgba(255,255,255,.6)",
                                        fontSize: CHART_CONFIG.fontSize,
                                        fontFamily: CHART_CONFIG.fontFamily
                                    },
                                },
                                splitLine: {
                                    lineStyle: { color: 'rgba(255,255,255,.1)' }
                                }
                            }],
                            series: [{
                                name: '报警次数',
                                type: 'line',
                                smooth: true,
                                symbol: 'circle',
                                symbolSize: 5,
                                showSymbol: false,
                                lineStyle: {
                                    normal: {
                                        color: '#00d887',
                                        width: 2
                                    }
                                },
                                areaStyle: {
                                    normal: {
                                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                            offset: 0,
                                            color: 'rgba(0, 216, 135, 0.4)'
                                        }, {
                                            offset: 0.8,
                                            color: 'rgba(0, 216, 135, 0.1)'
                                        }], false),
                                        shadowColor: 'rgba(0, 0, 0, 0.1)',
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        color: '#00d887',
                                        borderColor: 'rgba(221, 220, 107, .1)',
                                        borderWidth: 12
                                    }
                                },
                                data: alarmCounts
                            }]
                        };

                        alarmChart.setOption(option);
                    }
                });

                window.addEventListener("resize", () => alarmChart?.resize());
            });
        }

        function fetchAlarmData() {
            $.ajax({
                url: '../api/SmartScreen/DoorAlarmGetGridJson',
                type: 'GET',
                dataType: "json",
                data: {
                    page: 1,
                    rows: 10,
                    isOperation: 0
                },
                success: function (res) {
                    if (!res || !res.data) {
                        console.warn('获取报警数据为空');
                        return;
                    }

                    // 清空现有表格内容
                    const tbody = $('.alarm-record-table tbody');
                    tbody.empty();

                    // 生成新的表格行
                    res.data.forEach(record => {
                        const statusClassMap = {
                            '0': 'status-pending',
                            '1': 'status-processed',
                        }

                        const statusTextMap = {
                            '0': '未处理',
                            '1': '已处理',
                        }

                        const statusClass = statusClassMap[record.isOperation] || 'status-norecord';
                        const statusText = statusTextMap[record.isOperation] || '无记录';

                        const row = `
                            <tr>
                                <td title="${record.doc_name || '-'}">${record.doc_name || '-'}</td>
                                <td title="${record.EquipmentName || '-'}">${record.EquipmentName || '-'}</td>
                                <td title="${record.CreateTime || '-'}">${record.CreateTime || '-'}</td>
                                <td class="${statusClass}" title="${statusText}">${statusText}</td>
                            </tr>
                        `;
                        tbody.append(row);
                    });

                    // 如果数据少于10条，补充空行保持表格高度
                    const currentRows = tbody.children().length;
                    if (currentRows < 10) {
                        const emptyRows = new Array(10 - currentRows).fill(`
                            <tr>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>
                        `).join('');
                        tbody.append(emptyRows);
                    }
                },
                error: function (err) {
                    console.error('获取报警数据失败:', err);
                    // 显示错误提示
                    const tbody = $('.alarm-record-table tbody');
                    tbody.html(`
                        <tr>
                            <td colspan="4" style="text-align: center; color: #ff4d4f;">
                                获取数据失败，请稍后重试
                            </td>
                        </tr>
                    `);
                }
            });
        }
        // 刷新所有数据
        function refreshAllData() {
            console.log("refreshAllData");
            fetchStatisticsData();
            fetchAlarmData();
            initDocumentTypeChart();
            initCarrierTypeChart();
            initOutingStatsChart();
            initAlarmStatsChart();
        }

        // 注册定时刷新图表
        function registerRefreshTimer() {
            // const interval = 10 * 60 * 1000;
            const interval = 10 * 1000;
            setInterval(refreshAllData, interval);
        }

        // 页面初始化
        $(function () {
            updateDateTime();
            fetchStatisticsData();
            fetchAlarmData()
            initDocumentTypeChart();
            initCarrierTypeChart();
            initOutingStatsChart();
            initAlarmStatsChart();
            registerRefreshTimer();

        });
    </script>
</body>

</html>
